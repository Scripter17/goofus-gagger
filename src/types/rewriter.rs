use std::str::FromStr;
use std::collections::HashSet;

use rand::prelude::*;
use rand::distr::weighted::*;
use serde::{Serialize, Deserialize};
use thiserror::Error;

#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Hash, Serialize, Deserialize, poise::macros::ChoiceParameter)]
pub enum GagModeName {
    #[default]
    Gag,
    Dog,
    Cow,
    Fox,
    Cat
}

impl GagModeName {
    pub fn all() -> HashSet<Self> {
        [Self::Gag, Self::Dog, Self::Cow, Self::Fox, Self::Cat].into()
    }

    pub fn icon(&self) -> &'static str {
        match self {
            Self::Gag => "🔴",
            Self::Dog => "🐶",
            Self::Cow => "🐮",
            Self::Fox => "🦊",
            Self::Cat => "🐱"
        }
    }
}

#[derive(Debug, Error)]
#[error("Unknwon GagModeName")]
pub struct UnknownGagModeName;

impl FromStr for GagModeName {
    type Err = UnknownGagModeName;

    fn from_str(s: &str) -> Result<Self, Self::Err> {
        match &*s.to_ascii_lowercase() {
            "gag" => Ok(Self::Gag),
            "dog" => Ok(Self::Dog),
            "cow" => Ok(Self::Cow),
            "fox" => Ok(Self::Fox),
            "cat" => Ok(Self::Cat),
            _ => Err(UnknownGagModeName)
        }
    }
}

impl std::fmt::Display for GagModeName {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> Result<(), std::fmt::Error> {
        f.write_str(match self {
            Self::Gag => "Gag",
            Self::Dog => "Dog",
            Self::Cow => "Cow",
            Self::Fox => "Fox",
            Self::Cat => "Cat"
        })
    }
}

impl GagModeName {
    pub fn get(&self) -> &'static GagMode {
        match self {
            Self::Gag => &GAG_REWRITER,
            Self::Dog => &DOG_REWRITER,
            Self::Cow => &COW_REWRITER,
            Self::Fox => &FOX_REWRITER,
            Self::Cat => &CAT_REWRITER
        }
    }
}

pub const REWRITER_STATES: usize = 16;

pub struct GagMode {
    pub chars: [char; REWRITER_STATES],
    pub first: [u8; REWRITER_STATES],
    pub next: [[u8; REWRITER_STATES]; REWRITER_STATES]
}

#[derive(Debug, Error)]
pub enum GagModeError {
    #[error(transparent)]
    WeightError(#[from] rand::seq::WeightError)
}

impl GagMode {
    pub fn rewrite(&self, text: &str) -> Result<String, GagModeError> {
        let mut ret = String::with_capacity(text.len());
        let mut rng = rand::rng();
        let get_first = WeightedIndex::new(self.first)?;
        let mut ochar = get_first.sample(&mut rng);
        for c in text.chars() {
            if c.is_alphabetic() {
                ret.push_str(&if c.is_uppercase() {self.chars[ochar].to_uppercase().to_string()} else {self.chars[ochar].to_lowercase().to_string()});
                ochar = WeightedIndex::new(self.next[ochar])?.sample(&mut rng);
            } else {
                ret.push(c);
                ochar = get_first.sample(&mut rng);
            }
        }
        Ok(ret)
    }
}

#[allow(dead_code, reason = "Used for copy pasting")]
pub const EMPTY_REWRITER: GagMode = GagMode {
    chars: [' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '],
    first: [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
    next: [
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ]
    ]
};

pub const GAG_REWRITER: GagMode = GagMode {
    chars: ['h','m','f' , ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '],
    first: [ 4 , 2 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
    next: [
           [ 2 , 4 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 1 , 4 , 2  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 2 , 1 , 4  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],

           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ]
    ]
};

pub const DOG_REWRITER: GagMode = GagMode {
    chars: ['a','w','r','u','f' , 'w','o','f' , 'b','a','r','k','!' , 'a','w','o'],
    first: [ 4 , 2,  2 , 0 , 0  ,  4 , 0 , 0  ,  1 , 0 , 0 , 0 , 0  ,  1 , 0 , 0 ],
    next: [
           [ 1 , 2 , 2 , 1 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 1 , 1 , 2 , 2 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 1 , 1 , 2 , 4 , 4  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 1 , 1 , 1 , 1 , 4  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 1 , 1 , 2 , 1 , 2  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],

           [ 0 , 0 , 0 , 0 , 0  ,  1 , 4 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  1 , 4 , 2  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 1  ,  0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 ],

           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 4 , 0 , 0 , 0  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 1 , 2 , 0 , 0  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 1 , 1 , 0  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 1 , 1 , 1  ,  0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 1  ,  0 , 0 , 0 ],

           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  1 , 1 , 0 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  0 , 1 , 2 ],
           [ 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0  ,  1 , 1 , 4 ]
    ]
};

pub const COW_REWRITER: GagMode = GagMode {
    chars: ['m','o' , ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '],
    first: [ 1 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
    next: [
           [ 1 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],

           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ]
    ]
};

pub const FOX_REWRITER: GagMode = GagMode {
    chars: ['a','e','h' , ' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' '],
    first: [ 1 , 1 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
    next: [
           [ 1 , 1 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 1 , 1 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 1 , 1 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],

           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ]
    ]
};

pub const CAT_REWRITER: GagMode = GagMode {
    chars: ['m','r','e','o','a','u','w' , ' ',' ',' ',' ',' ',' ',' ',' ',' '],
    first: [ 4 , 2 , 1 , 0 , 1 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
    next: [
           [ 1 , 2 , 2 , 1 , 2 , 1 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 1 , 2 , 2 , 2 , 1 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 2 , 2 , 2 , 2 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 2 , 2 , 2 , 2 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 2 , 2 , 2 , 2 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 2 , 2 , 2 , 2 , 1  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 1 , 1 , 1 , 1 , 2  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],

           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ],
           [ 0 , 0 , 0 , 0 , 0 , 0 , 0  ,  0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 ]
    ]
};
